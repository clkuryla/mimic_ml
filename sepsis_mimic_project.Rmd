---
title: "ML MIMIC Sepsis Project"
author: "Christine Lucille Kuryla"
date: "2024-12-07"
output: 
  html_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

```

# Article

Hou, N., Li, M., He, L. et al. Predicting 30-days mortality for MIMIC-III patients with sepsis-3: a machine learning approach using XGboost. J Transl Med 18, 462 (2020). https://doi.org/10.1186/s12967-020-02620-5

https://translational-medicine.biomedcentral.com/articles/10.1186/s12967-020-02620-5 

# Data from online article

## Load Data
```{r load_data}
# Downloaded from: https://translational-medicine.biomedcentral.com/articles/10.1186/s12967-020-02620-5#Sec14

# This data has all of the patients included in the study, after they filtered out certain patients due to the exclusion criteria in the paper
# n = 4559

data <- read_csv("data/12967_2020_2620_MOESM1_ESM.csv") 

# colnames(data)

# Remove duplicates

# all(data$icustay_id...1 == data$icustay_id...103) # TRUE
# all(data$hadm_id...102 == data$hadm_id...2) # TRUE

data <- data %>% 
  mutate(icustay_id = icustay_id...1,
         hadm_id = hadm_id...2
         ) %>% 
  select(-c("icustay_id...1", "icustay_id...103",
            "hadm_id...2", "hadm_id...102"
            ))

# Some methods need numeric data, some need different variable types. Let's create two dataframes.

data_numeric <- data

# Convert into appropriate data types

data_vartypes <- data %>% 
  mutate(intime = dmy_hms(intime),
         outtime = dmy_hms(outtime),
         dbsource = as_factor(dbsource),
         suspected_infection_time_poe = dmy_hms(suspected_infection_time_poe),
         specimen_poe = as_factor(specimen_poe),
         positiveculture_poe = as_factor(positiveculture_poe),
         antibiotic_time_poe = dmy_hms(antibiotic_time_poe),
         blood_culture_time = dmy_hms(blood_culture_time),
         blood_culture_positive = as_factor(blood_culture_positive),
         gender = as_factor(gender),
         # is_male = as_factor(is_male), # should we delete this?
         ethnicity = as_factor(ethnicity),
         race_white = as_factor(race_white),
         race_black = as_factor(race_black),
         race_hispanic = as_factor(race_hispanic),
         race_other = as_factor(race_other),
         metastatic_cancer = as_factor(metastatic_cancer),
         diabetes = as_factor(diabetes),
         first_service = as_factor(first_service),
         hospital_expire_flag = as_factor(hospital_expire_flag),
         thirtyday_expire_flag = as_factor(thirtyday_expire_flag),
         sepsis_angus = as_factor(sepsis_angus),
         sepsis_martin = as_factor(sepsis_martin),
         sepsis_explicit = as_factor(sepsis_explicit),
         septic_shock_explicit = as_factor(septic_shock_explicit),
         severe_sepsis_explicit = as_factor(severe_sepsis_explicit),
         sepsis_nqf = as_factor(sepsis_nqf),
         sepsis_cdc = as_factor(sepsis_cdc),
         sepsis_cdc_simple = as_factor(sepsis_cdc_simple),
         elixhauser_hospital = as_factor(elixhauser_hospital), # what does this mean?
         vent = as_factor(vent),
         # sofa
         # lods
         # sirs
         # qsofa
         qsofa_sysbp_score = as_factor(qsofa_sysbp_score),
         qsofa_gcs_score = as_factor(qsofa_gcs_score),
         qsofa_resprate_score = as_factor(qsofa_resprate_score),
         rrt = as_factor(rrt)
         # colloid_bolus has 4050 NAs!!! n = 4559!!!
         # crystalloid_bolus has 1194 NAs
         # icustayid
         # hadm_id
         # subject_id
  )



```

# Article Analysis Reproduction 

## Statistical Summaries of Variables

```{r}

# Statistical analysis steps
# Normally distributed continuous variables were
# summarized as the mean ± SD
# Continuous variables of normal distribution were tested by Kolmogorov–Smirnov test
# Non-normally distributed continuous variables were summarized as the median
# Student’s t test, One-way ANOVA, Mann–Whitney U or Kruskal–Wallis H test were used to compare continuous data of non-normally distribution, if appropriate.
# Categorical variables were expressed as numbers or percentage and assessed using Chi-square test or Fisher’s exact test according to different sample sizes as proper
# Fisher’s uses smaller sample sizes: 20 or 30?

```

#### Table 1
Baseline characteristics, vital signs, laboratory parameters and statistic results of mimic-III patients with sepsis. 

```{r}

```

#### Figure 2

##### Figure 2a
Overall ethnicity characteristics pie chart

```{r}

```

##### Figure 2b
The common sources of infection pie chart

```{r}

```

## Three Predictive Models

### Conventional Logistic Regression Model

```{r}

# conducted using these significant variables identified by backward stepwise analysis with Chi-square test. Then we chose an entry probability of <0.05 by the stepwise selection method

library(dplyr)
library(lubridate)  # For date-time conversions
library(readr)      # For reading CSV files
library(MASS)
```

```{r}
# CLEAN THE DATA
# # Fit the full model
# full_model <- glm(
#   thirtyday_expire_flag ~ . - dbsource,
#   data = data_vartypes,
#   family = binomial
# )
# Find columns with only one unique value
single_level_vars <- sapply(data_vartypes, function(x) is.factor(x) && length(unique(x)) < 2)

# Display these variables
names(single_level_vars[single_level_vars])

# # Remove single-level factor variables
# data_vartypes_rmv_a <- data_vartypes[, !single_level_vars]

# Identify numeric columns with zero variance
zero_variance_vars <- sapply(data_vartypes, function(x) is.numeric(x) && var(x, na.rm = TRUE) == 0)

# Display these variables
names(zero_variance_vars[zero_variance_vars])

# Check factor levels and missing values
factor_levels_check <- sapply(data_vartypes, function(x) if (is.factor(x)) length(levels(x)) else NA)
# factor_levels_check

# Combine problematic variables
problematic_vars <- c(
  names(single_level_vars[single_level_vars]),
  names(zero_variance_vars[zero_variance_vars]),
  names(single_level_vars[single_level_vars])
)

# Remove them from the dataset
data_vartypes_clean <- data_vartypes[, !(names(data_vartypes) %in% problematic_vars)]

str(data_vartypes_clean)

```

```{r}
# Fit the full model
full_model <- glm(
  thirtyday_expire_flag ~ . - suspected_infection_time_poe_days - is_male - hosp_los - icu_los,
  data = data_vartypes_clean,
  family = binomial
)
# 
# Backward stepwise selection
stepwise_model <- step(
  full_model,
  direction = "backward",
  k = log(nrow(data_vartypes_clean)) # Using BIC
)
# # Stepwise selection
# stepwise_model <- stepAIC(
#   full_model,
#   direction = "both",
#   trace = TRUE
# )
# Summarize the final model
summary(stepwise_model)


```

```{r}
# Convert thirtyday_expire_flag to a factor
# data_vartypes$thirtyday_expire_flag <- as.factor(data_vartypes$thirtyday_expire_flag)

# Choose predictors (subset)
predictors <- c("age", "gender", "sofa", "qsofa", "vent", "icu_los", "hosp_los")

# Clean the dataset with no missing values for the selected predictors
logistic_data <- data_vartypes %>%
  select(all_of(c(predictors, "thirtyday_expire_flag"))) %>%
  drop_na()

# Run the logistic regression using the glm function
# Logistic regression
logistic_model <- glm(
  thirtyday_expire_flag ~ age + gender + sofa + qsofa + vent + icu_los + hosp_los,
  data = logistic_data,
  family = binomial
)
# Summarize the model
summary(logistic_model)

# Start with a full model including all potential predictors
full_model <- glm(
  thirtyday_expire_flag ~ .,
  # thirtyday_expire_flag ~ age + gender + sofa + qsofa + vent + icu_los + hosp_los + other_predictors,
  data = logistic_data,
  family = binomial
)

# Perform backward stepwise selection
stepwise_model <- step(
  full_model,
  direction = "backward",
  k = log(nrow(logistic_data))  # Default criterion: BIC; change to AIC if needed
)

# View the final selected model
summary(stepwise_model)
```
```{r}
# Start with the full model
current_model <- glm(
  thirtyday_expire_flag ~ .,
  # thirtyday_expire_flag ~ age + gender + sofa + qsofa + vent + icu_los + hosp_los,
  data = logistic_data,
  family = binomial
)

# Iteratively remove variables
while (TRUE) {
  model_summary <- summary(current_model)
  p_values <- coef(model_summary)[, 4]  # Extract p-values for coefficients
  predictors <- names(p_values)[-1]  # Exclude intercept

  # Check if any predictors have p-value > 0.05
  if (all(p_values[-1] <= 0.05)) break

  # Find the predictor with the highest p-value
  highest_p <- max(p_values[-1])
  variable_to_remove <- predictors[which.max(p_values[-1])]
  
  if (length(predictors) <= 1) {
  warning("All variables have been removed; stopping.")
  break
  }


  # Update formula by removing the variable
  formula <- as.formula(paste(
    "thirtyday_expire_flag ~",
    paste(setdiff(all.vars(formula(current_model)), variable_to_remove), collapse = " + ")
  ))

  # Fit the updated model
  current_model <- glm(formula, data = logistic_data, family = binomial)
}


# Final model after backward elimination
summary(current_model)
```


#### Table 2
Features selected in the conventional logistic regression 

```{r}

```

### SAPS-II Score Model

```{r}

# we used these time-stamp variables to do prediction based on the methods provided by the original literature of SAPS II [16]

```

### XGBoost Algorithm Model

```{r}

# performed XGBoost model [17, 18] to analysis the contribution (gain) of each variable to 30-days mortality
# at the same time, backward stepwise analysis was processed to select the variable with a threshold of p < 0.05 according to the Akaike information criterion (AIC) [19]
# After identifying the variables through XGBoost, we used these clinical and laboratory variables included to construct the XGBoost algorithm model

```

#### Table 3
Features selected in the XGboost model

```{r}

```

#### Figure 3
Analysis results of each features’ contribution by XGBoost model 

```{r}

```

## Model Comparison

### ROC/AUC and DCA

```{r}

# Tested and compared the performances of the three predictive models by area under curves (AUCs) of the receiver operating characteristic curves (ROC) and decision curve analysis (DCA), then selected the model that achieved the highest overall diagnostic value for further verification

```

#### Figure 4
ROC curves of the three models

```{r}

```

#### Figure 5
Decision curve analysis (DCA) of the three prediction models

```{r}

```


### Nomogram and Clinical Impact Curve (CIC) 

```{r}
# At last, nomogram and clinical impact curve (CIC) were plotted to evaluate the clinical usefulness and applicability net benefits of the model with the best diagnostic value
```

#### Figure 6
Nomogram to estimate the risk of mortality in sepsis patients (for visualization of the XGboost predictive model)

```{r}

```

#### Figure 7
Clinical impact curve (CIC) of XGboost model 

```{r}

```


# Additional Analyses

# Compare Original to Additional Analysis Methods

